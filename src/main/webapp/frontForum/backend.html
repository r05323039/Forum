<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>論壇管理後台</title>
    <link type="text/css" rel="stylesheet" href="../frontForum/backend.css"/>
    <!--    <link type="text/css" rel="stylesheet" href="../backend.css"/>-->

    <template class="category-backend-template">
        <section class="backend">
            <div class="buttons">
                <button class="add-button">新增話題</button>
                <button class="search-button">分類搜索</button>
            </div>
            <div class="checkboxes"></div>
        </section>
    </template>

    <template class="category-checkbox-template">
        <div class="checkbox">
            <input type="checkbox"/>
            <div class="cdn-img"></div>
            <div class="category-name"></div>
        </div>
    </template>

    <template class="posts-template">
        <div class="post-info">
            <div class="user"></div>
            <div class="category"></div>
            <div class="topic"></div>
            <div class="date"></div>
            <button class="view">檢視</button>
        </div>
    </template>

    <template class="post-template">
        <div class="post-info">
            <div class="user"></div>
            <div class="category"></div>
            <div class="topic"></div>
            <div class="date"></div>
            <div class="like"></div>
        </div>
        <p class="content"></p>
        <div class="img"></div>
        <button class="post-delete">刪除</button>

    </template>
    <template class="msg-template">
        <article class="msg-article">
            <div class="d1">
                <div class="user"></div>
                </br>
                <div class="date"></div>
            </div>
            <div class="d2" data-value="">
                <p class="content"></p>
            </div>
            <hr/>
            <div class="d3">
                <div class="m-like" data-value="">
                    <i class="fa-solid fa-thumbs-up"></i>
                    <span class="showLike"></span>
                </div>
                <div class="msg-img"/>
            </div>
        </article>
    </template>
</head>
<body>
<main>
    <div class="btns">
        <button class="backend-btn">討論區管理</button>
    </div>
    <div class="panel"></div>
</main>
</body>

<script>
    //backend主模板
    const panel = document.querySelector(".panel");
    //討論區管理
    const categoryBtn = document.querySelector(".backend-btn");
    categoryBtn.addEventListener("click", () => {
        getBackend()
    });

    function getBackend() {
        //取得話題後台模板並clone實體
        const categoryBackend = document.querySelector(".category-backend-template").content.cloneNode(true);
        //取得資料庫categoryList，並填入checkboxes
        const checkboxes = categoryBackend.querySelector(".checkboxes");
        const checkboxTemp = document.querySelector(".category-checkbox-template").content;
        fetch("../backend/categoryList")
            .then((response) => response.text())
            .then((text) => JSON.parse(text))
            .then((data) => {
                // console.log(data);
                for (let i = 0; i < data.length; i++) {
                    let checkboxClone = checkboxTemp.cloneNode(true);
                    checkboxClone.querySelector("input[type='checkbox']").id = data[i].id;
                    checkboxClone.querySelector(".category-name").innerText = data[i].category;
                    checkboxes.append(checkboxClone);
                }
                panel.innerHTML = '';
                panel.appendChild(categoryBackend);
            })//話題填充完畢

        //新增話題按鈕
        const addCategoryBtn = categoryBackend.querySelector(".add-button")
        addCategoryBtn.addEventListener("click", () => {
            if (!panel.querySelector("form")) {
                let form = document.createElement("form");
                form.innerHTML = '<input type="text" placeholder="話題名稱" name="newCategory">' +
                    '<input type="submit" value="確認送出">';
                form.addEventListener("submit", (event) => {
                    event.preventDefault();
                    fetch("../backend/categoryAdd", {
                        method: "post",
                        body: new FormData(form)
                    })
                        .then(response => response.text())
                        .then((text) => JSON.parse(text))
                        .then((data) => {
                            if (data == true) {
                                alert("新增成功")
                            } else {
                                alert("話題重複，請重新輸入")
                            }
                        })
                })
                panel.appendChild(form);
            }
        });

        //批量搜尋按鈕
        const SearchBtn = categoryBackend.querySelector(".search-button")
        SearchBtn.addEventListener("click", () => {
            let checkedIds = [];
            const checkboxlist = document.querySelectorAll(".checkbox");
            for (let i = 0; i < checkboxlist.length; i++) {
                const checkbox = checkboxlist[i].querySelector("input[type='checkbox']");
                if (checkbox.checked) {
                    checkedIds.push(checkbox.id)
                }
            }
            if (checkedIds.length > 0) {
                const encodedIds = encodeURIComponent(JSON.stringify(checkedIds));
                fetch("../backend/postSearch?ids=" + encodedIds)
                    .then((response) => response.text())
                    .then((text) => JSON.parse(text))
                    .then((data) => {
                        // console.log(data);
                        if (data.length > 0) {
                            panel.innerHTML = '';
                            panel.appendChild(fillPostsTemplate(data));
                        }
                    })
            } else {
                alert("請選擇要搜尋的分類");
            }
        })

    }//getBackend()

    //批量搜尋文章，填充模板並回傳posts
    function fillPostsTemplate(data) {
        const postsTemp = document.querySelector(".posts-template").content;
        const posts = document.createElement("div");
        posts.classList.add("posts");
        for (let i = 0; i < data.length; i++) {
            const post = postsTemp.cloneNode(true);
            post.querySelector(".user").innerText = data[i].userName;
            post.querySelector(".category").innerText = data[i].category;
            post.querySelector(".topic").innerText = data[i].topic;
            post.querySelector(".date").innerText = data[i].timestamp;
            post.querySelector(".view").addEventListener("click", () => {
                viewBtnListener(data[i].postId);
            })
            posts.appendChild(post);
        }
        return posts
    }

    //文章檢視Listener
    function viewBtnListener(postId) {
        fetch("../forum/postBean?postId=" + postId)
            .then(response => response.text())
            .then(text => JSON.parse(text))
            .then(data => {
                console.log(data);
                const postByView = fillPostTemplate(data.post)
                panel.innerHTML = '';
                panel.appendChild(postByView)

                const msgs = data.msgs;

                const msglength = data.dataLength;

                // console.log(msgs);
                // console.log(msglength);

            })
    }

    //填入post-template
    function fillPostTemplate(postData) {
        const postView = document.createElement("div");
        postView.classList.add("post-view");

        const postTemp = document.querySelector(".post-template").content;
        const post = postTemp.cloneNode(true);
        post.querySelector(".user").innerText = postData.userName;
        post.querySelector(".category").innerText = postData.category;
        post.querySelector(".topic").innerText = postData.topic;
        post.querySelector(".date").innerText = postData.timestamp;
        post.querySelector(".like").innerText = "like:" + postData.like;
        post.querySelector(".content").innerText = postData.content;

        const postImgs = post.querySelector(".img");
        const postDataImgs = postData.imgs;
        console.log(postDataImgs);
        if (postDataImgs != null && postDataImgs.length > 0) {
            for (let i = 0; i < postDataImgs.length; i++) {
                const postImg = document.createElement("img");
                postImg.src = "data:image/jpeg;base64," + postDataImgs[i];
                postImgs.appendChild(postImg)
            }
        }

        post.querySelector(".post-delete").addEventListener("click", () => {
            postDelete(postData.postId);
        })

        postView.appendChild(post)
        return postView
    }

    //刪除文章
    function postDelete(postId) {
        if (confirm("您確定刪除?")) {
            fetch("../backend/delete?postId=" + postId)
                .then(response => response.text())
                .then(text => JSON.parse(text))
                .then(data => {
                    console.log(data);
                    if(data == true){
                        alert("刪除成功")
                        window.location.href="../frontForum/backend.html";
                    }else {
                        alert("刪除失敗")
                    }
                })
        }
    }

    //填入msg-template
    // function msgTemplateFill(msg, templateMsg) {
    //     const msgClone = templateMsg.cloneNode(true);
    //     msgClone.querySelector(".user").textContent = msg.userName;
    //     msgClone.querySelector(".date").textContent = msg.timestamp;
    //     msgClone.querySelector(".d2").setAttribute('data-value', msg.msgId);
    //     msgClone.querySelector(".content").textContent = msg.content;
    //     msgClone.querySelector(".d3").setAttribute('data-value', msg.msgId);
    //     msgClone.querySelector(".m-like").setAttribute('data-value', msg.msgId);
    //     msgClone.querySelector(".showLike").textContent = msg.like;
    //
    //     const msgImgs = msg.imgs;
    //     if (msgImgs != null && msgImgs.length > 0) {
    //         const msgImgsDiv = msgClone.querySelector(".msg-img");
    //         for (let i = 0; i < msgImgs.length; i++) {
    //             const imgElement = document.createElement("img");
    //             imgElement.src = "data:image/jpeg;base64," + msgImgs[i];
    //             msgImgsDiv.appendChild(imgElement)
    //         }
    //     }
    //     return msgClone;
    // }
</script>
</html>
